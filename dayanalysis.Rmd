---
author: 'Mohit Chander Gulla'
title: "Airline Delays Leading Up To & After Thanksgiving"
output: html_document

---
```{r, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = TRUE)
```

```{r}
library(ggplot2)
library(dplyr)
library(ggthemes)
library(tidyr)
library(stringr)

thanksgiving = read.csv('thanksgiving.csv')
```

```{r}
thanksgiving = thanksgiving %>% 
  mutate(OP_UNIQUE_CARRIER = recode(OP_UNIQUE_CARRIER, 
                                    "9E" = "Endeavor Air",
                                    "EV" = "ExpressJet",
                                    "G4" = "Allegiant",
                                    "HA" = "Hawaiian",
                                    "MQ" = "Envoy",
                                    "OH" = "PSA",
                                    "OO" = "SkyWest",
                                    "VX" = "Virgin America",
                                    "YV" = "Mesa",
                                    "YX" = "Republic",
                                    "AA" = "American",
                                    "AS" = "Alaska",
                                    "B6" = "JetBlue",
                                    "DL" = "Delta",
                                    "F9" = "Frontier",
                                    "NK" = "Spirit",
                                    "UA" = "United",
                                    "WN" = "Southwest"))

thanksgiving = thanksgiving %>% 
  mutate(DAY_OF_WEEK = recode(DAY_OF_WEEK, 
                              "3" = "Wednesday",
                              "4" = "Thursday",
                              "5" = "Friday",
                              "6" = "Saturday",
                              "7" = "Sunday"))

thanksgiving = thanksgiving %>% 
  filter(OP_UNIQUE_CARRIER %in% c('American','Alaska','JetBlue','Delta','Frontier','Spirit','United','Southwest'))

thanksgiving$DAY_OF_WEEK = factor(thanksgiving$DAY_OF_WEEK, 
                                  levels = c("Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

```

We will now deep dive into our data to analyze how airline delays look like leading up to and post Thanksgiving. This will help us ascertain whether there is a general trend, across the years, of airline delays owing to specific days. For our analysis we will consider the trend in delays across 5 days. Thanksgiving each year falls on a Thursday and as we are looking to observe the pattern pre and post Thanksgiving we will consider data from Wednesday to Sunday. 

As stated earlier, we are limiting the data to the 5 days of the Thanksgiving travel period, in order ensure that we stay in a season with similar weather and travel patterns. Moreover, in order to get an accurate sense of flight delays across US during Thanksgiving, we have chosen to consider only the 8 major airlines that according to us see the heaviest traffic.

```{r}

delay_by_day = thanksgiving %>% 
  group_by(DAY_OF_WEEK) %>% 
  summarise("Departure Delay" = mean(DEP_DELAY_NEW, na.rm=TRUE), 
            "Arrival Delay" = mean(ARR_DELAY_NEW, na.rm=TRUE))
delay_by_day = gather(delay_by_day, "delay_type", "delay_time", 2:3)

ggplot(delay_by_day, aes(DAY_OF_WEEK, y = delay_time, group = delay_type)) +
  geom_line(aes(linetype = delay_type)) + 
  geom_point() +
  ggtitle("Avg. Arrival & Departure Delay During Thanksgiving") +
  labs(x = "Day of Week", 
       y = "Average Delay (mins)") +
  theme(legend.title = element_blank(),
        plot.title = element_text(face = "bold"))

```

**Inference**: Our data captures flight delays both at origin and destination, and as there can be multiple causes for a delay, it is subdivived into the different categories of delay such as weather delay, carrier delay, taxi delay, etc. Therefore, before we continue to analyze the flight delays and their behavior with respect to other features, we would like to fix our delay variable to one that is of most applicable. 

The above graph indicates that across all data points, the average departure delay is slightly higher than the average arrival delay. This observation is actually very intuitive as there is scope for flights under delay at the origin city to make up some time in air before it lands at its destination. As average delay is almost equal at arrival and departure, and because for a traveller the delay in arrival matter more, we will proceed our analysis.

```{r}
delay_by_dept_time = thanksgiving %>% 
  group_by(DEP_TIME) %>% 
  summarise(arr_delay = mean(ARR_DELAY_NEW, na.rm=TRUE))

delay_by_dept_time$DEP_TIME = str_pad(delay_by_dept_time$DEP_TIME, 4, pad = "0")
delay_by_dept_time$DEP_TIME = substr(delay_by_dept_time$DEP_TIME, 1, 2)

delay_by_dept_time = delay_by_dept_time %>% 
  group_by(DEP_TIME) %>% 
  summarise(arr_delay_mean = mean(arr_delay))
delay_by_dept_time = delay_by_dept_time %>% filter(!is.na(DEP_TIME))

ggplot(delay_by_dept_time, aes(x = DEP_TIME, y = arr_delay_mean)) +
  geom_bar(stat = "identity") + 
  coord_polar(theta = "x") +
  ggtitle("Avg. Arrival Delay Based on Departure Time") +
  labs(x = "Departure Hour (24 Hour Format)", 
       y = "Average Delay (mins)") +
  theme(axis.ticks = element_blank(), plot.title = element_text(face = "bold"))
```

**Inference**: We would now like to identify if there is any pattern to delay based on the departure time of flights. We are expecting that there would be more delays during peak hours which can cause a chain reaction and lead to subsequent flight delays. After plotting the departure hour of flights on a radial axis, we get to see something interesting and unsual. Contradictory to our expectation, the average delay of flights is much higher at the very starting of the day, between 1AM-4AM, drastically drops starting 5PM and continues to increase gradually till the end of the day. Though the gradual increase can be due to chain reaction of delays, the extremely high delay in the 1AM-4AM window could be due to an outlier and we will deep dive into this more to understand the reason.

```{r}

cancellations_by_day = thanksgiving %>% 
  group_by(year, DAY_OF_WEEK) %>% 
  summarise(cancellations = sum(CANCELLED, na.rm=TRUE))

ggplot(cancellations_by_day, aes(x = DAY_OF_WEEK, y = cancellations)) +
  geom_bar(stat = "identity") + 
  facet_wrap(~year) +
  ggtitle("Total Flight Cancellations During Thanksgiving Week (2015-2018)") +
  labs(x = "Day of Week", 
       y = "Total Cancellations") +
  theme(legend.title = element_blank(),
        plot.title = element_text(face = "bold"))
```

**Inference**: As we suspect that outliers might have introduced higher flight delay in the 1AM-4AM period as compared to the rest of the day, we would like to check if the pattern is consistent across days of the week or across different years. Moreover, on exploring our data we understood that in extreme situations, there is more chances of flights getting cancelled all together than them suffering a high delay.

Faceting the total number of flight cancellations across years and observing it across the day of week lead us to some very interesting insight. As we can see from the above plot, there were an extremely high number of flight cancellations on the Sunday of 2018. This tells us that a one off event, due to weather or airport or carrier issues, large scale delays happened on this particular day and it most likely does not relate to delay because of Thanksgiving rush.

```{r}

sunday_2018 = thanksgiving %>% 
  filter(DAY_OF_WEEK == 'Sunday' & year == 2018) %>% 
  drop_na(ARR_DELAY_NEW, WEATHER_DELAY, CARRIER_DELAY) %>% 
  group_by(OP_UNIQUE_CARRIER) %>% 
  summarise(arr_delay = mean(ARR_DELAY_NEW, na.rm=TRUE),
            weather_delay = mean(WEATHER_DELAY, na.rm = TRUE),
            carrier_delay = mean(CARRIER_DELAY, na.rm = TRUE)) %>% 
  mutate(arr_delay = arr_delay - (weather_delay + carrier_delay))

sunday_2018 = gather(sunday_2018, "delay_type", "delay_time", 2:4)

ggplot(sunday_2018, aes(x = reorder(OP_UNIQUE_CARRIER, -delay_time), 
                        fill = delay_type, y = delay_time)) +
  geom_bar(position = "stack", stat = "identity") + 
  ggtitle("Cause of Flight Delays for Major Airlines in 2018 Sunday") +
  labs(x = "Airline", 
       y = "Average Delay (mins)") +
  theme(legend.title = element_blank(),
        plot.title = element_text(face = "bold"))

```

**Inference**: The next direction we took was to analyze whether a particular carrier contributed / suffered the most in terms of flight delays. Also, it would be important for us to also understand the cause for delay across carriers. Looking at the results, it is interesting to observe that United Airlines suffered major delays that were caused because of weather. The delays due to internal reasons within airlines are fairly consistent and nothing unusual comes out of it.

Continuing to deep dive into this issue, we found a news article online talking specifically about the day and the year we were observing. The link to the article is below:

https://www.usatoday.com/story/travel/flights/todayinthesky/2018/11/25/snow-flights-canceled-storm-snarls-post-thanksgiving-sunday/2107525002/

A snippet from this aricle:

*Most of those came in the Midwest, where a winter storm was bringing snow, ice and rain to a swath of the Great Plains and Midwest. Blizzard conditions were possible Sunday across parts of Iowa, Illinois, Missouri and Wisconsin.*

*Oâ€™Hare is a major connecting hub for both United and American, each of which had canceled hundreds of mainline and regional flights. By FlightAware's count. the cancellations accounted for more than 25 percent of Sunday's entire schedule at O'Hare. For Monday, more than 180 flights -- about 5 percent of the day's schedule -- had already been grounded by Sunday evening.*

This backs our hypothesis that the delay on this particular day is attributed to weather reasons and not because of Thanksgiving rush. Essentially these datapoints should be removed as it skews the overall analysis.