---
title: "EDAV Final Project"
author: "Ben Livingston"
date: "12/5/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Introduction

(Problem statement)

(Let's do an initial comparison for the airlines)


```{r echo=FALSE}
library(ggplot2)
library(dplyr)
library(ggthemes)
library(forcats)
library(ggpubr)
library(lubridate)
library(tidyr)
library(stringr)
library(reshape2)

thanksgiving = read.csv('thanksgiving.csv')
alldates = read.csv('alldates.csv')
```

```{r echo=FALSE}
thanksgiving = thanksgiving %>% mutate(OP_UNIQUE_CARRIER = recode(OP_UNIQUE_CARRIER, "9E" = "Endeavor Air",
                                                                  "EV" = "ExpressJet",
                                                                  "G4" = "Allegiant",
                                                                  "HA" = "Hawaiian",
                                                                  "MQ" = "Envoy",
                                                                  "OH" = "PSA",
                                                                  "OO" = "SkyWest",
                                                                  "VX" = "Virgin America",
                                                                  "YV" = "Mesa",
                                                                  "YX" = "Republic",
                                                                  "AA" = "American",
                                                                  "AS" = "Alaska",
                                                                  "B6" = "JetBlue",
                                                                  "DL" = "Delta",
                                                                  "F9" = "Frontier",
                                                                  "NK" = "Spirit",
                                                                  "UA" = "United",
                                                                  "WN" = "Southwest"))

alldates = alldates %>% mutate(OP_UNIQUE_CARRIER = recode(OP_UNIQUE_CARRIER, "9E" = "Endeavor Air",
                                                                  "EV" = "ExpressJet",
                                                                  "G4" = "Allegiant",
                                                                  "HA" = "Hawaiian",
                                                                  "MQ" = "Envoy",
                                                                  "OH" = "PSA",
                                                                  "OO" = "SkyWest",
                                                                  "VX" = "Virgin America",
                                                                  "YV" = "Mesa",
                                                                  "YX" = "Republic",
                                                                  "AA" = "American",
                                                                  "AS" = "Alaska",
                                                                  "B6" = "JetBlue",
                                                                  "DL" = "Delta",
                                                                  "F9" = "Frontier",
                                                                  "NK" = "Spirit",
                                                                  "UA" = "United",
                                                                  "WN" = "Southwest"))
```


```{r echo=FALSE}
by_airline = thanksgiving %>% group_by(OP_UNIQUE_CARRIER) %>% summarize(delay = mean(ARR_DELAY_NEW,na.rm=TRUE)) %>% arrange(-delay)

ggplot(by_airline,aes(x=fct_reorder(OP_UNIQUE_CARRIER,delay),y=delay)) + 
  geom_col(position='dodge',fill='black') +
  theme_calc() + 
  xlab('') +
  ylab('Average Delay (Minutes)') +
  coord_flip() +
  ggtitle('Average Thanksgiving Holiday Flight Delays') +
  theme(plot.title = element_text(hjust = 0.5))  +
  theme(plot.subtitle = element_text(hjust = 0.5))
```

Ultra low-cost carrier Allegiant leads the pack in Thanksgivng delays, which isn't surprising considering its reputation (but wait, more on this in a second!). Regional airline Mesa Airlines comes next. Hawaiian Airlines has the fewest delays of any airline. 

It is clear that focusing on large carriers will make the most sense for our purposes, since consumers are typically unfamiliar with regional airlines that fly under either a single mainline carrier's brand or multiple brands, and those airlines tend to be available for only a small set of routes.

Among the three major legacy carriers, Delta has the fewest delays, followed by American Airlines, and United performs by far the worst. Southwest (WN) performs a little better than American Airlines, and Alaska Airlines (AS) performs a little worse than American Airlines.

Does this change by year, though? How much does our data vary by year?
```{r echo=FALSE, fig.height=8}
by_year = thanksgiving %>% group_by(OP_UNIQUE_CARRIER,year) %>% summarize(delay = mean(ARR_DELAY_NEW,na.rm=TRUE))

ggplot(by_year,aes(x=fct_reorder(OP_UNIQUE_CARRIER,delay),y=delay,fill=as.factor(year))) + 
  geom_col(position=position_dodge2(preserve = "single",width=1)) +
  scale_color_brewer(palette='Set3') +
  theme_calc() +
  xlab('') +
  ylab('Average Delay (Minutes)') +
  labs(fill = 'Year') +
  coord_flip()  +
  ggtitle('Average Thanksgiving Holiday Flight Delays') +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.title = element_text(hjust = 0.5)) +
  guides(fill = guide_legend(reverse=T))
  
```

We will examine year-to-year patterns (particularly the horrors of Thanksgiving Sunday 2018) later, but for now, this graph provides a curious revelation: Allegiant did not have any flights during the Thanksgiving holiday before 2018. No wonder its on time performance was so terrible - it only flew on Thanksgiving during the year when delays were by far the worst.

This furthers our conviction that focusing on large, national, major mainline airlines that flew in all four years will make the most sense for our purposes.

We will apply the following criteria for removing airlines:  

*Must have flown flights during Thanksgiving all four years
*Regional or heavily region-specific airlines (regional airlines would be contracted carriers such as Mesa, heavily region-focused airlines would be like Hawaiian Airlines).
*Inactive airlines

For this reason, we have decided to remove the following airlines:
*Endeavor Air (9E)
*ExpressJet (EV)
*Allegiant (G4)
*Hawaiian Airlines (HA)
*Envoy Air (MQ)
*PSA Airlines (OH)
*SkyWest Airlines (OO)
*Virgin America (VX)
*Mesa Airlines (YV)
*Republic Airways (YX)

Which leaves us with the following airlines:
*American Airlines (AA)
*Alaska Airlines (AS)
*JetBlue (B6)
*Delta (DL)
*Frontier (F9)
*Spirit (NK)
*United Airlines (UA)
*Southwest (WN)


```{r}
thanksgiving = thanksgiving %>% filter(OP_UNIQUE_CARRIER %in% c('American','Alaska','JetBlue','Delta','Frontier','Spirit','United','Southwest'))

alldates = alldates %>% filter(OP_UNIQUE_CARRIER %in% c('American','Alaska','JetBlue','Delta','Frontier','Spirit','United','Southwest')) 
```


```{r echo=FALSE}
thanksgiving_region <- thanksgiving %>% mutate(region = if_else(DEST_STATE_ABR=="AK","West",
                                                       if_else(DEST_STATE_ABR=="AL","South",
                                                       if_else(DEST_STATE_ABR=="AR","South",
                                                       if_else(DEST_STATE_ABR=="AZ","West",
                                                       if_else(DEST_STATE_ABR=="CA","West",
                                                       if_else(DEST_STATE_ABR=="CO","West",
                                                       if_else(DEST_STATE_ABR=="CT","Northeast",
                                                       if_else(DEST_STATE_ABR=="DC","South",
                                                       if_else(DEST_STATE_ABR=="DE","South",
                                                       if_else(DEST_STATE_ABR=="FL","South",
                                                       if_else(DEST_STATE_ABR=="GA","South",
                                                       if_else(DEST_STATE_ABR=="HI","West",
                                                       if_else(DEST_STATE_ABR=="IA","Midwest",
                                                       if_else(DEST_STATE_ABR=="ID","West",
                                                       if_else(DEST_STATE_ABR=="IL","Midwest",
                                                       if_else(DEST_STATE_ABR=="IN","Midwest",
                                                       if_else(DEST_STATE_ABR=="KS","Midwest",
                                                       if_else(DEST_STATE_ABR=="KY","South",
                                                       if_else(DEST_STATE_ABR=="LA","South",
                                                       if_else(DEST_STATE_ABR=="MA","Northeast",
                                                       if_else(DEST_STATE_ABR=="MD","South",
                                                       if_else(DEST_STATE_ABR=="ME","Northeast",
                                                       if_else(DEST_STATE_ABR=="MI","Midwest",
                                                       if_else(DEST_STATE_ABR=="MN","Midwest",
                                                       if_else(DEST_STATE_ABR=="MO","Midwest",
                                                       if_else(DEST_STATE_ABR=="MS","South",
                                                       if_else(DEST_STATE_ABR=="MT","West",
                                                       if_else(DEST_STATE_ABR=="NC","South",
                                                       if_else(DEST_STATE_ABR=="ND","Midwest",
                                                       if_else(DEST_STATE_ABR=="NE","Midwest",
                                                       if_else(DEST_STATE_ABR=="NH","Northeast",
                                                       if_else(DEST_STATE_ABR=="NJ","Northeast",
                                                       if_else(DEST_STATE_ABR=="NM","West",
                                                       if_else(DEST_STATE_ABR=="NV","West",
                                                       if_else(DEST_STATE_ABR=="NY","Northeast",
                                                       if_else(DEST_STATE_ABR=="OH","Midwest",
                                                       if_else(DEST_STATE_ABR=="OK","South",
                                                       if_else(DEST_STATE_ABR=="OR","West",
                                                       if_else(DEST_STATE_ABR=="PA","Northeast",
                                                       if_else(DEST_STATE_ABR=="RI","Northeast",
                                                       if_else(DEST_STATE_ABR=="SC","South",
                                                       if_else(DEST_STATE_ABR=="SD","Midwest",
                                                       if_else(DEST_STATE_ABR=="TN","South",
                                                       if_else(DEST_STATE_ABR=="TX","South",
                                                       if_else(DEST_STATE_ABR=="UT","West",
                                                       if_else(DEST_STATE_ABR=="VA","South",
                                                       if_else(DEST_STATE_ABR=="VT","Northeast",
                                                       if_else(DEST_STATE_ABR=="WA","West",""
                                                          )))))))))))))))))))))))))))))))))))))))))))))))))

thanksgiving_region$region<- ifelse(thanksgiving_region$DEST_STATE_ABR=="WI" & thanksgiving_region$region =="","Midwest",                   
                                                      ifelse(thanksgiving_region$DEST_STATE_ABR=="WV" & thanksgiving_region$region =="","South",
                                                       ifelse(thanksgiving_region$DEST_STATE_ABR=="AL" & thanksgiving_region$region =="","South",
                                                       ifelse(thanksgiving_region$DEST_STATE_ABR=="WY" & thanksgiving_region$region=="","West",thanksgiving_region$region))))

thanksgiving_region<-thanksgiving_region %>% filter(!region %in% c(""))
```

```{r echo=FALSE}
by_region_delay2 = thanksgiving_region %>% group_by(region) %>% summarize(delay = mean(ARR_DELAY_NEW,na.rm=TRUE))

ggplot(by_region_delay2,aes(x=region,y=delay)) + 
  geom_col(position=position_dodge2(preserve = "single",width=1),fill='black') +
  theme_calc() +
  xlab('') +
  ylab('Average Delay (Minutes)') +
  ggtitle('Thanksgiving Holiday Flight Delays By Region')+
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) 
```



```{r echo=FALSE}
by_region_delay = thanksgiving_region %>% group_by(region,year) %>% summarize(delay = mean(ARR_DELAY_NEW,na.rm=TRUE))

ggplot(by_region_delay,aes(x=region,y=delay,fill=as.factor(year))) + 
  geom_col(position=position_dodge2(preserve = "single",width=1)) +
  theme_calc() +
  ylab('Average Delay (Minutes)') +
  ggtitle('Thanksgiving Holiday Flight Delays Grouped By Region & Year')+
  theme(axis.title.x=element_blank())+
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.title = element_blank()) +
  theme(legend.position = 'bottom',legend.direction='horizontal')
```

(Add here: seems like Northeast and West have worse delays, and that delays don't cluster to one region - probably because flight nertworks are all interconnected)

```{r}
by_region_delay = thanksgiving_region %>% mutate(delay_ind = if_else(thanksgiving_region$ARR_DELAY_NEW >0,"Delay","No Delay")) %>% group_by(region,delay_ind) %>% summarise(Freq=n())

vcd::mosaic(region ~ delay_ind,
       gp = grid::gpar(fill = c("lightblue", "blue"),
                 col = "white"),
       spacing = vcd::spacing_equal(sp = unit(0, "lines")),
       by_region_delay,
       labeling=vcd::labeling_border(rot_labels = c(20,0,0,90)),
       main = 'Flights Delays: Grouped By Region')


```

The mosaic plot indicates that there is absolutely no relationship between the region and delay (meaning zero correlation). We can attribute this to the fact that the regions are very general and we might have to look at more granular level data to see which region/airports in specific are affected with respect the on time performance of the flights. 


```{r echo=FALSE, fig.height=10}
by_flight_delay = thanksgiving_region %>% group_by(OP_UNIQUE_CARRIER,region) %>% summarize(delay = mean(ARR_DELAY_NEW,na.rm=TRUE))

ggplot(by_flight_delay,aes(x=OP_UNIQUE_CARRIER,y=delay,fill=OP_UNIQUE_CARRIER)) + 
  geom_col(position=position_dodge2(preserve = "single",width=1)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab('') +
  coord_flip() +
  theme_calc() +
  facet_wrap(~region,nrow=4)+
  ylab('Average Delay (Minutes)') +
  labs(fill = 'Year') + 
  ggtitle('Thanksgiving Flight Delays By Region')+
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_colour_manual(
    values = c('American'='#787890','Alaska'='#8caa48','JetBlue'='#003876',
               'Delta'='#C01933','Frontier'='#248168','Spirit'='#feea67',
               'United'='#8099d0','Southwest'='#5e2e24'),
    aesthetics = c("colour", "fill")) 
  
  
```


(Add here - does best airline choice change by region in any significant ways?)

With a cursory glance, it seems thatthe OTP for all the regions are same there. But delving deeper into it surely gives some inference and it tells that there  is definitely some difference in the OTP between the airlines and the region they fly in. 

Here, we see that in the South, Delta and Southwest Airlines have the best performance followed by American Airlines which is quite intuitive and a little research tells us that Southwest has its base in Dallas, TX allowing it to have a leverage over the other airlines. American airlines is also headquartered in Fort Worth, TX making it the second best OTP airline (At least based on the data). Even though most airlines were affected in 2018, the aforementioned airlines played it well. Overall the southern region seem to performing really well than the other 3. However the difference is not statistically significant and hence in order to draw some inference, we need to move towards more granular approach. 


```{r echo=FALSE, fig.width=6, fig.height=12}
thanksgiving_region_dot_plot<-thanksgiving_region[thanksgiving_region$year!=2018,] %>% group_by(DEST) %>%
                              summarise(delay=mean(ARR_DELAY_NEW,na.rm=TRUE)) %>% arrange(-delay)

thanksgiving_region_dot_plot<-thanksgiving_region_dot_plot[c(1:50),]

thanksgiving_region_dot_plot<-unique(merge(thanksgiving_region_dot_plot,thanksgiving_region[,c("DEST","region")],by="DEST",all.x = TRUE))


theme_dotplot <- theme_bw(14) +
    theme(axis.text.y = element_text(size = rel(.75)),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = rel(.75)),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 0.5),
        panel.grid.minor.x = element_blank())

# create the plot
ggplot(thanksgiving_region_dot_plot, aes(x = delay, y = reorder(DEST, delay),color=region)) +
    geom_point(color = "red") +
    theme_dotplot +
    xlab("\nAverage Delay (Minutes)") +
    ylab("Airports\n") +
    ggtitle("Thanksgiving Holiday Flight Delays By Airport")+
  theme(plot.title = element_text(hjust = 0.5)) 

```


A cleveland dot plot of average delay time with respect to the airports tells us that the worst affected airports are the Rapid City Regional Airport in South Dakota, Santa Barbara, Hector International airport based out of North Dakota. Since these are small and not so famous airports where people genrally rush to during thanksgiving holidays, we try to go beyond this cleveland dot plot and consider top busiest airports in the US.

Comparing by airports now (Region is too specific)


```{r echo=FALSE}
top_10_airports<-alldates %>% group_by(DEST) %>% summarise(cnt =n()) %>% arrange(-cnt)
top_10_airports<-top_10_airports$DEST[1:10]
alldates_top10<-alldates[alldates$DEST %in% top_10_airports,]
```

```{r echo=FALSE, fig.height=8}
by_airport_delay_tg = alldates_top10 %>% filter(period == "Thanksgiving") %>% group_by(DEST,year,period) %>% summarize(delay = mean(ARR_DELAY_NEW,na.rm=TRUE))

by_airport_delay_ntg = alldates_top10 %>%  filter(period =="Pre-Thanksgiving") %>% group_by(DEST,year,period) %>% summarize(delay = mean(ARR_DELAY_NEW,na.rm=TRUE))

by_airport_delay<-bind_rows(by_airport_delay_tg,by_airport_delay_ntg)

ggplot(by_airport_delay,aes(x=DEST,y=delay,fill=as.factor(year))) + 
  geom_col(position=position_dodge2(preserve = "single",width=1)) +
  facet_wrap(~period,nrow=2)+
  theme_calc() +
  xlab('') +
  ylab('Average Delay (Minutes)') +
  ggtitle('Airport Flight Delays Before/During Thanksgiving Holiday') +
  theme(plot.title = element_text(hjust = 0.5))  +
  theme(legend.title = element_blank()) +
  guides(fill = guide_legend(reverse=T)) +
  coord_flip() 
  
```


```{r echo=FALSE, fig.height=3, fig.width=7}
alldates_top10_cancellations_Thanksgiving <- alldates_top10[alldates_top10$period =="Thanksgiving" &alldates_top10$year!=2018,] %>% group_by(DEST) %>% summarise(No_of_cnc = sum(CANCELLED,na.rm=TRUE)/20) %>% arrange(-No_of_cnc)

alldates_top10_cancellations_Thanksgiving<-alldates_top10_cancellations_Thanksgiving[c(1:10),]

alldates_top10_cancellations_Thanksgiving$DEST <- 
  factor(alldates_top10_cancellations_Thanksgiving$DEST, 
         levels = alldates_top10_cancellations_Thanksgiving$DEST
         [order(-alldates_top10_cancellations_Thanksgiving$No_of_cnc)])

  

  alldates_top10_cancellations_Non_Thanksgiving <- alldates_top10[alldates_top10$period =="Pre-Thanksgiving" &alldates_top10$year!=2018,] %>% group_by(DEST) %>% summarise(No_of_cnc = sum(CANCELLED,na.rm=TRUE)/80) %>% arrange(-No_of_cnc)
  
  alldates_top10_cancellations_Non_Thanksgiving<-alldates_top10_cancellations_Non_Thanksgiving[c(1:10),]
  
  alldates_top10_cancellations_Non_Thanksgiving$DEST <- 
    factor(alldates_top10_cancellations_Non_Thanksgiving$DEST, 
           levels = alldates_top10_cancellations_Non_Thanksgiving$DEST
           [order(-alldates_top10_cancellations_Non_Thanksgiving$No_of_cnc)])
 
  alldates_top10_cancellations_Thanksgiving$period<-"Thanksgiving"
alldates_top10_cancellations_Non_Thanksgiving$period<-"Pre-Thanksgiving"
no_of_cancellations<-bind_rows(alldates_top10_cancellations_Thanksgiving,alldates_top10_cancellations_Non_Thanksgiving)

ggplot(no_of_cancellations,aes(x=DEST,y=No_of_cnc,fill=as.factor(period))) + 
  geom_col(position=position_dodge2(preserve = "single",width=1)) +
  scale_color_brewer(palette='Set3') +
  theme_calc() +
  xlab('Airport') +
  ylab('Flights Cancelled Per Day') +
  ggtitle('Flight Cancellations For Ten Biggest Airports') +
  labs(subtitle = '20 Days Before Thanksgiving Holiday vs. Thanksgiving Holiday') +
  theme(plot.title = element_text(hjust = 0.5))  +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  theme(legend.position = 'bottom')

```


Clearly, the Non thanksgiving period has more flights cancelled per day compared to the thanksgiving period.
As we can see, during the Thanksgiving period, Of the 10 busiest airports, Phoenix has most no of cancelled flights per day followed by San Francisco and Las Vegas (Although these are very miniscule). During the Non thanksgiving days, Chicago and Denver are the worst affected airports. 

```{r echo=FALSE, fig.width=7, fig.height=3}
alldates_top10_delays_Thanksgiving <- alldates_top10[alldates_top10$period =="Thanksgiving" &alldates_top10$year!=2018,] %>% group_by(DEST) %>% summarise(No_of_delay = sum(if_else(ARR_DELAY_NEW>0,1,0),na.rm=TRUE)/20) %>% arrange(-No_of_delay)

alldates_top10_delays_Thanksgiving<-alldates_top10_delays_Thanksgiving[c(1:10),]

alldates_top10_delays_Thanksgiving$DEST <- 
  factor(alldates_top10_delays_Thanksgiving$DEST, 
         levels = alldates_top10_delays_Thanksgiving$DEST
         [order(-alldates_top10_delays_Thanksgiving$No_of_delay)])

alldates_top10_delays_Non_Thanksgiving <- alldates_top10[alldates_top10$period =="Pre-Thanksgiving" &alldates_top10$year!=2018,] %>% group_by(DEST) %>% summarise(No_of_delay = sum(if_else(ARR_DELAY_NEW>0,1,0),na.rm=TRUE)/80) %>% arrange(-No_of_delay)

alldates_top10_delays_Non_Thanksgiving<-alldates_top10_delays_Non_Thanksgiving[c(1:10),]

alldates_top10_delays_Non_Thanksgiving$DEST <- 
  factor(alldates_top10_delays_Non_Thanksgiving$DEST, 
         levels = alldates_top10_delays_Non_Thanksgiving$DEST
         [order(-alldates_top10_delays_Non_Thanksgiving$No_of_delay)])

alldates_top10_delays_Thanksgiving$period<-"Thanksgiving"
alldates_top10_delays_Non_Thanksgiving$period<-"Pre-Thanksgiving"
no_of_delays<-bind_rows(alldates_top10_delays_Thanksgiving,alldates_top10_delays_Non_Thanksgiving)

ggplot(no_of_delays,aes(x=DEST,y=No_of_delay,fill=as.factor(period))) + 
  geom_col(position=position_dodge2(preserve = "single",width=1)) +
  theme_calc() +
  ylab('Flight Delays Per Day') +
  ggtitle('Flight Delays For Ten Biggest Airports') +
  labs(subtitle = '20 Days Before Thanksgiving Holiday vs. Thanksgiving Holiday') +
  theme(plot.title = element_text(hjust = 0.5))  +
  theme(axis.title.x = element_blank()) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  theme(legend.position = 'bottom',legend.direction='horizontal') +
  theme(legend.title = element_blank())
```

Tha above plot shows that flight delays per day during the Thanksgiving period is not significantly different from the Pre-Thanksgiving period except for Atlanta which is based out of Georgia. 

```{r echo=FALSE}
thanksgiving2 = thanksgiving %>% 
  mutate(DAY_OF_WEEK = recode(DAY_OF_WEEK, 
                              "3" = "Wednesday",
                              "4" = "Thursday",
                              "5" = "Friday",
                              "6" = "Saturday",
                              "7" = "Sunday"))

thanksgiving2$DAY_OF_WEEK = factor(thanksgiving2$DAY_OF_WEEK, 
                                  levels = c("Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

```

We will now deep dive into our data to analyze how airline delays look like leading up to and post Thanksgiving. This will help us ascertain whether there is a general trend, across the years, of airline delays owing to specific days. For our analysis we will consider the trend in delays across 5 days. Thanksgiving each year falls on a Thursday and as we are looking to observe the pattern pre and post Thanksgiving we will consider data from Wednesday to Sunday. 

As stated earlier, we are limiting the data to the 5 days of the Thanksgiving travel period, in order ensure that we stay in a season with similar weather and travel patterns. Moreover, in order to get an accurate sense of flight delays across US during Thanksgiving, we have chosen to consider only the 8 major airlines that according to us see the heaviest traffic.

```{r echo=FALSE}

delay_by_day = thanksgiving2 %>% 
  group_by(DAY_OF_WEEK) %>% 
  summarise("Departure Delay" = mean(DEP_DELAY_NEW, na.rm=TRUE), 
            "Arrival Delay" = mean(ARR_DELAY_NEW, na.rm=TRUE))

delay_by_day = gather(delay_by_day, "delay_type", "delay_time", 2:3)

ggplot(delay_by_day, aes(DAY_OF_WEEK, 
                         y = delay_time, 
                         group = delay_type)) +
  
  geom_line(aes(linetype = delay_type)) + 
  geom_point() +
  ggtitle("Average Arrival & Departure Delay During Thanksgiving") +
  labs(x = "Day of Week", 
       y = "Average Delay (mins)") +
  theme_calc() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  guides(linetype = guide_legend(title="Delay Type")) +
  theme(legend.title = element_text(hjust = 0.5))
```

**Inference**: Our data captures flight delays both at origin and destination, and as there can be multiple causes for a delay, it is subdivived into the different categories of delay such as weather delay, carrier delay, taxi delay, etc. Therefore, before we continue to analyze the flight delays and their behavior with respect to other features, we would like to fix our delay variable to one that is of most applicable. 

The above graph indicates that across all data points, the average departure delay is slightly higher than the average arrival delay. This observation is actually very intuitive as there is scope for flights under delay at the origin city to make up some time in air before it lands at its destination. As average delay is almost equal at arrival and departure, and because for a traveller the delay in arrival matter more, we will proceed our analysis.

```{r echo=FALSE}
delay_by_dept_time = thanksgiving2 %>% 
  group_by(DEP_TIME) %>% 
  summarise(arr_delay = mean(ARR_DELAY_NEW, na.rm=TRUE))

delay_by_dept_time$DEP_TIME = str_pad(delay_by_dept_time$DEP_TIME, 4, pad = "0")
delay_by_dept_time$DEP_TIME = substr(delay_by_dept_time$DEP_TIME, 1, 2)

delay_by_dept_time = delay_by_dept_time %>% 
  mutate(DEP_TIME = replace(DEP_TIME, DEP_TIME == "24", "00")) %>% 
  group_by(DEP_TIME) %>% 
  summarise(arr_delay_mean = mean(arr_delay))

delay_by_dept_time = delay_by_dept_time %>% filter(!is.na(DEP_TIME))

ggplot(delay_by_dept_time, aes(x = DEP_TIME, y = arr_delay_mean)) +
  geom_bar(stat = "identity") + 
  coord_polar(theta = "x") +
  ggtitle("Average Arrival Delay Based on Departure Time") +
  labs(x = "Departure Hour (24 Hour Format)", 
       y = "Average Delay (mins)") +
  theme_calc() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  theme(legend.title = element_text(hjust = 0.5))
```

**Inference**: We would now like to identify if there is any pattern to delay based on the departure time of flights. We are expecting that there would be more delays during peak hours which can cause a chain reaction and lead to subsequent flight delays. After plotting the departure hour of flights on a radial axis, we get to see something interesting and unsual. Contradictory to our expectation, the average delay of flights is much higher at the very starting of the day, between 1AM-4AM, drastically drops starting 5PM and continues to increase gradually till the end of the day. Though the gradual increase can be due to chain reaction of delays, the extremely high delay in the 1AM-4AM window could be due to an outlier and we will deep dive into this more to understand the reason.

```{r echo=FALSE}
cancellations_by_day = thanksgiving2 %>% 
  group_by(year, DAY_OF_WEEK) %>% 
  summarise(cancellations = sum(CANCELLED, na.rm=TRUE))

ggplot(cancellations_by_day, aes(x = DAY_OF_WEEK, y = cancellations)) +
  geom_bar(stat = "identity") + 
  facet_wrap(~year) +
  ggtitle("Total Flight Cancellations During Thanksgiving Week (2015-2018)") +
  labs(x = "Day of Week", 
       y = "Total Cancellations") +
  theme_calc() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  theme(legend.title = element_text(hjust = 0.5))
```

**Inference**: As we suspect that outliers might have introduced higher flight delay in the 1AM-4AM period as compared to the rest of the day, we would like to check if the pattern is consistent across days of the week or across different years. Moreover, on exploring our data we understood that in extreme situations, there is more chances of flights getting cancelled all together than them suffering a high delay.

Faceting the total number of flight cancellations across years and observing it across the day of week lead us to some very interesting insight. As we can see from the above plot, there were an extremely high number of flight cancellations on the Sunday of 2018. This tells us that a one off event, due to weather or airport or carrier issues, large scale delays happened on this particular day and it most likely does not relate to delay because of Thanksgiving rush.

```{r echo=FALSE}

sunday_2018 = thanksgiving2 %>% 
  filter(DAY_OF_WEEK == 'Sunday' & year == 2018) %>% 
  drop_na(ARR_DELAY_NEW, WEATHER_DELAY, CARRIER_DELAY) %>% 
  group_by(OP_UNIQUE_CARRIER) %>% 
  summarise(arr_delay = mean(ARR_DELAY_NEW, na.rm=TRUE),
            weather_delay = mean(WEATHER_DELAY, na.rm = TRUE),
            carrier_delay = mean(CARRIER_DELAY, na.rm = TRUE)) %>% 
  mutate(arr_delay = arr_delay - (weather_delay + carrier_delay)) %>% 
  rename("Arrival Delay" = arr_delay,
         "Weather Delay" = weather_delay,
         "Carrier Delay" = carrier_delay)

sunday_2018 = gather(sunday_2018, "delay_type", "delay_time", 2:4)

ggplot(sunday_2018, aes(x = reorder(OP_UNIQUE_CARRIER, -delay_time), 
                        fill = delay_type, y = delay_time)) +
  geom_bar(position = "stack", stat = "identity") + 
  ggtitle("Cause of Flight Delays for Major Airlines in 2018 on Sunday") +
  labs(x = "Airline", 
       y = "Average Delay (mins)") +
  theme_calc() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  guides(fill = guide_legend(title="Delay Type")) +
  theme(legend.title = element_text(hjust = 0.5))
```

**Inference**: The next direction we took was to analyze whether a particular carrier contributed / suffered the most in terms of flight delays. Also, it would be important for us to also understand the cause for delay across carriers. Looking at the results, it is interesting to observe that United Airlines suffered major delays that were caused because of weather. The delays due to internal reasons within airlines are fairly consistent and nothing unusual comes out of it.

Continuing to deep dive into this issue, we found a news article online talking specifically about the day and the year we were observing. The link to the article is below:

https://www.usatoday.com/story/travel/flights/todayinthesky/2018/11/25/snow-flights-canceled-storm-snarls-post-thanksgiving-sunday/2107525002/

A snippet from this aricle:

*Most of those came in the Midwest, where a winter storm was bringing snow, ice and rain to a swath of the Great Plains and Midwest. Blizzard conditions were possible Sunday across parts of Iowa, Illinois, Missouri and Wisconsin.*

*O’Hare is a major connecting hub for both United and American, each of which had canceled hundreds of mainline and regional flights. By FlightAware's count. the cancellations accounted for more than 25 percent of Sunday's entire schedule at O'Hare. For Monday, more than 180 flights -- about 5 percent of the day's schedule -- had already been grounded by Sunday evening.*

This backs our hypothesis that the delay on this particular day is attributed to weather reasons and not because of Thanksgiving rush. Essentially these datapoints should be removed as it skews the overall analysis.

#############
# BEN PART
#############

We will now answer a vital question: how has airline OTP during the Thanksgiving holiday compared to airline OTP outside of the Thanksgiving holiday since the mergers of the major US airlines?

We will research this question by comparing the 20 days before the Thanksgiving travel rush to the 5 days of the Thanksgiving travel period, in order ensure that we stay in a season with similar weather and travel patterns. We note, however, that likely captured **some** early Thanksgiving travel (which can be equally or perhaps even moreso plagued by delays).

We also share a caveat (which applies to all this research) that the four years since the recent major US airline mergers completed is a small sample size, and major weather events and airline disruptions could cause some skewness in this data. 

That being said, let's compare Thanksgiving and pre-Thanksgiving.

```{r echo=FALSE}
by_period_all = alldates %>% group_by(period) %>% summarize(delay = mean(ARR_DELAY_NEW,na.rm=TRUE))

ggplot(by_period_all,aes(x=period,y=delay,fill=period)) + 
  geom_col(position='dodge') +
  theme_calc() + 
  xlab('Period') +
  ylab('Average Delay') +
  ggtitle('Major Eight Airline Delays In November') + 
  scale_colour_manual(
    values = c('red','blue'),
    aesthetics = c("colour", "fill"))  +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) + 
  theme(legend.position = "none")
```

A stunner: over the past four years, airlines have actually gotten better at on-time performance during Thanksgiving. 

There's an important caveat worth mentioning here: the data we are using considers any early flight to be simply "on-time" (and does not give it a negative delay value), as we believe that it makes the most sense to call a spade a spade and consider any flight that isn't late to be on time. 

However, flights are typically early when all goes right, so it's possible that Thanksgiving causes a lot of shorter "delays" that result in flights being on-time instead of early, meaning Thanksgiving flights aren't really quicker. 

Still though, with that caveat, our result stands: and at the very least, it seems evident that delays don't get worse during Thanksgiving (at least for flights that aren't cancelled or diverted, which we'll address later).

Now let's examine how this trend plays out for different airlines.

```{r echo=FALSE}
by_airline_n = alldates %>% group_by(OP_UNIQUE_CARRIER,period) %>% summarize(delay = mean(ARR_DELAY_NEW,na.rm=TRUE))

ggplot(by_airline_n,aes(x=OP_UNIQUE_CARRIER,y=delay,fill=period)) + 
  geom_col(position='dodge') +
  theme_calc() + 
  xlab('Airline') +
  ylab('Average Delay') +
  ggtitle('Airline Delays In November... Before & During Thanksgiving') + 
  labs(subtitle = '20 Days Before Thanksgiving Holiday vs. Thanksgiving Holiday') +
  scale_colour_manual(
    values = c('red','blue'),
    aesthetics = c("colour", "fill")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  guides(fill=guide_legend(title="Period")) +
  theme(legend.title = element_text(hjust = 0.5))
```


```{r echo=FALSE}
delay_c = alldates %>% 
  group_by(OP_UNIQUE_CARRIER,period) %>% 
  summarize(delay = mean(ARR_DELAY_NEW,na.rm=TRUE)) %>%
  ungroup() %>%
  mutate(delay_change = 100*(delay - lag(delay))/lag(delay)) %>%
  filter(period=='Thanksgiving')

ggplot(delay_c,aes(x=OP_UNIQUE_CARRIER,y=delay_change,fill=OP_UNIQUE_CARRIER)) +
  geom_col(position='dodge') +
  theme_calc() +
  xlab('Airline') +
  ylab('Percent Change In Average Delay') + 
  ggtitle('Airline Delay Swings During Thanksgiving') +
  labs(subtitle = '20 Days Before Thanksgiving Holiday vs. Thanksgiving Holiday') +
  scale_colour_manual(
    values = c('American'='#787890','Alaska'='#8caa48','JetBlue'='#003876',
               'Delta'='#C01933','Frontier'='#248168','Spirit'='#feea67',
               'United'='#8099d0','Southwest'='#5e2e24'),
    aesthetics = c("colour", "fill")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  guides(fill=guide_legend(title="Airline")) +
  theme(legend.title = element_text(hjust = 0.5))

```

All eight airlines see their on-time performance improve during Thanksgiving.

Outside of that, the most evident (and strangest) trend here is that Spirit Airlines and Frontier Airlines - two ultra low-cost carriers with poor service reputations - have had a significantly shorter average flight delay during the Thanksgiving holiday than they did prior to the Thanksgiving holiday, particularly Spirit Airlines.

This suggests that there is no need to avoid Spirit and Frontier during the Thanksgiving holiday. In fact, one could argue if there's any time to fly these airlines, it's Thanksgiving: their OTP has lagged much less during this peak travel period. United (the third-worst airline for OTP) also sees an improvement in performance during Thanksgiving.

Perhaps Thanksgiving has a normalizing effect on these airlines. Frontier technically still has the worst Thanksgiving travel delays of any of these airlines, but they close the gap by a remarkable margin.

So flight delays are shorter during Thanksgiving. Surprise!

Are there more long delays, though - say, those over 30 minutes? Let's consider that now.

```{r echo=FALSE}
delays_over_30 = alldates %>% filter(ARR_DELAY_NEW > 30)

by_airline_30 = delays_over_30 %>% group_by(OP_UNIQUE_CARRIER,period) %>% summarize(delay = mean(ARR_DELAY_NEW,na.rm=TRUE))

ggplot(by_airline_30,aes(x=OP_UNIQUE_CARRIER,y=delay,fill=period)) + 
  geom_col(position='dodge') +
  theme_calc() + 
  xlab('Airline') +
  ylab('Average Delay') +
  ggtitle('Delays of Over 30 Minutes') + 
  labs(subtitle = '20 Days Before Thanksgiving Holiday vs. Thanksgiving Holiday') +
  scale_colour_manual(
    values = c('red','blue'),
    aesthetics = c("colour", "fill")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  guides(fill=guide_legend(title="Period")) +
  theme(legend.title = element_text(hjust = 0.5))
```

It seems that long delays are a fairly random event across all airlines and dates, so not much to add there.

What about *really* long delays though? Which airlines have the most of those? 

```{r echo=FALSE}
ggplot(alldates) +
  geom_boxplot(aes(x = OP_UNIQUE_CARRIER, y = ARR_DELAY_NEW)) +
  coord_flip() +
  theme_calc() +
  xlab('') +
  ylab('') + 
  ggtitle('Long Airline Delays During November') +
  labs(subtitle = '20 Days Before Thanksgiving Holiday vs. Thanksgiving Holiday') +
  scale_colour_manual(
    values = c('American'='#787890','Alaska'='#8caa48','JetBlue'='#003876',
               'Delta'='#C01933','Frontier'='#248168','Spirit'='#feea67',
               'United'='#8099d0','Southwest'='#5e2e24'),
    aesthetics = c("colour", "fill")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  guides(fill=guide_legend(title="Airline")) +
  theme(legend.title = element_text(hjust = 0.5)) +
  facet_wrap(~period)
```

```{r echo=FALSE}
ggplot(alldates) +
  geom_boxplot(aes(x = period,y = ARR_DELAY_NEW,fill=period)) +
  coord_flip() +
  theme_calc() +
  xlab('') +
  ylab('') + 
  ggtitle('Long Airline Delays During November') +
  labs(subtitle = '20 Days Before Thanksgiving Holiday vs. Thanksgiving Holiday') +
  scale_colour_manual(
    values = c('red','blue'),
    aesthetics = c("colour", "fill")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  theme(legend.position = "none")
```

The airlines prone to extreme delays appear to have stayed the same before and during the Thanksgiving holiday. 

But now... what about the flights that aren't delayed, but just get flat-out cancelled, and thus don't even don't have a delay value to factor in? 

Let's take a look.

```{r echo=FALSE}
cancellations = alldates %>% 
  group_by(period) %>% 
  summarize(cancelled= sum(CANCELLED,na.rm=TRUE)) %>%
  mutate(divider = ifelse(period=='Thanksgiving',20,80)) %>%
  mutate(cancelled_per_day = cancelled/divider)

ggplot(cancellations,aes(x=period,y=cancelled_per_day,fill=period)) + 
  geom_col(position='dodge') +
  theme_calc() + 
  xlab('') +
  ylab('Cancellations') +
  ggtitle('Major Eight Airline Cancellations Per Day In November') +
  labs(subtitle = '20 Days Before Thanksgiving Holiday vs. Thanksgiving Holiday') +
  scale_colour_manual(
    values = c('red','blue'),
    aesthetics = c("colour", "fill")) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.subtitle = element_text(hjust = 0.5)) +
    guides(fill=guide_legend(title="Period")) + 
    theme(legend.position = "none")
```

We expected a rub here, but alas, cancellations drop as well during the Thanksgiving holiday. This further confirms our surprising result: at least over the last four years, traveling during Thanksgiving has been less delay- and cancellation-ridden than traveling before Thanksgiving.

Next we take a look at which airlines stepped up their getting-off-the-ground game the most.

```{r echo=FALSE}
cancellations = alldates %>% group_by(OP_UNIQUE_CARRIER,period) %>% summarize(cancelled= sum(CANCELLED,na.rm=TRUE)) %>%
  mutate(divider = ifelse(period=='Thanksgiving',20,80)) %>%
  mutate(cancelled_per_day = cancelled/divider)

ggplot(cancellations,aes(x=OP_UNIQUE_CARRIER,y=cancelled_per_day,fill=period)) + 
  geom_col(position='dodge') +
  theme_calc() + 
  xlab('Airline') +
  ylab('Cancellations') +
  ggtitle('Airline Cancellations Per Day In November') +
  labs(subtitle = '20 Days Before Thanksgiving Holiday vs. Thanksgiving Holiday') +
  scale_colour_manual(
    values = c('red','blue'),
    aesthetics = c("colour", "fill"))  +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.subtitle = element_text(hjust = 0.5)) +
    guides(fill=guide_legend(title="Period")) +
    theme(legend.title = element_text(hjust = 0.5))
```


```{r echo=FALSE}
cancellations_c = alldates %>% 
  group_by(OP_UNIQUE_CARRIER,period) %>% 
  summarize(cancellations = sum(CANCELLED,na.rm=TRUE))%>%
  mutate(divider = ifelse(period=='Thanksgiving',20,80)) %>%
  mutate(cancelled_per_day = cancellations/divider) %>%
  ungroup() %>%
  mutate(cancellation_change =
           100*(cancelled_per_day - lag(cancelled_per_day)) /
           lag(cancelled_per_day)) %>%
  filter(period=='Thanksgiving')

ggplot(cancellations_c,aes(x=OP_UNIQUE_CARRIER,y=cancellation_change,fill=OP_UNIQUE_CARRIER)) +
  geom_col(position='dodge') +
  theme_calc() +
  xlab('Airline') +
  ylab('Percent Change In Number Of Cancellations Per Day') + 
  ggtitle('Airline Cancellation Swings During Thanksgiving') +
  labs(subtitle='Pre-Thanksgiving To Thanksgiving Cancellations Per Day Change') +
  scale_colour_manual(
    values = c('American'='#787890','Alaska'='#8caa48','JetBlue'='#003876',
               'Delta'='#C01933','Frontier'='#248168','Spirit'='#feea67',
               'United'='#8099d0','Southwest'='#5e2e24'),
    aesthetics = c("colour", "fill")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  guides(fill=guide_legend(title="Airline")) +
  theme(legend.title = element_text(hjust = 0.5))

```

These differences appear to be nothing more than random variation, and we'll explain why.

The swing for JetBlue is massive - it went from 18.4 flights cancelled per day before the Thanksgiving holiday to 2.0 flights cancelled per day during the holiday. Such a wild swing doesn't make logical sense. Unless JetBlue invested massive resources in avoiding delays during this period (Which is certainly possible), it's difficult to imagine what could have caused such a reversal.

This suggests that cancellations are high-variation, "luck of the draw" (or more aptly put, "lack of luck of the draw") events, and measuring their swings is probably a fool's errand.

That being said, JetBlue has done an exceptionally good job of getting their flights in the air over the last four Thanksgiving holidays.

It's also worth noting that Southwest seems to have had extreme cancellation problems during the last four Novembers, but performed better during the holiday than before the holiday period.

Most airlines appeared to get a bit better at getting their flights in the air, except Delta, which was the only airline out of the eight to have more cancellations during the Thanksgiving holiday.

So overall, it certainly seems that travelling before Thanksgiving yields better results than traveling during Thanksgiving, a caveat that we mentioned earlier.

So let's see- if we examine the five days of the Thanksgiving travel rush and the 20 days before, do we see a peak in delays at any particular point? Could it be that the worst delays happen 3-5 days before Thanksgiving (i.e. the weekend before plus Monday and Tuesday), rather than during the traditional travel rush?

Let's see what the graphs say. 

```{r echo=FALSE}
bydates = alldates %>% 
  mutate(nday = mday(FL_DATE))

bydates$nday =
  ifelse(bydates$year == 2015, bydates$nday - 4,
  ifelse(bydates$year == 2016, bydates$nday - 2,
  ifelse(bydates$year == 2017, bydates$nday - 1,bydates$nday)))

bydatesgrouped = bydates %>%
  group_by(nday,year) %>%
  summarize(avgdelay = mean(ARR_DELAY_NEW,na.rm=TRUE))

ggplot(bydatesgrouped,aes(x=nday,y=avgdelay,color=as.factor(year)),) +
  geom_line(width=2) +
  geom_point() +
  geom_vline(xintercept=20.5) +
  annotate("text", label = "Thanksgiving Holiday", x = 23.4, y = 22, size = 3, colour = "black") +
  theme_calc() +
  xlab('Number Day In 25 Day Period Ending With Sunday After Thanksgiving') +
  ylab('Average Delay') + 
  ggtitle('How Average Major Airline Delays Evolve During November') +
  labs(subtitle='20 Days Before Thanksgiving Travel Period + Five Days During Thanksgiving Holiday') +
  scale_colour_manual(
    values = c('red','blue','darkgreen','orange'),
    aesthetics = c("colour", "fill")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  guides(color=guide_legend(title="Year")) +
  theme(legend.title = element_text(hjust = 0.5)) 
```

```{r echo=FALSE}
bydatesgrouped2 = bydates %>%
  group_by(nday) %>%
  summarize(avgdelay = mean(ARR_DELAY_NEW,na.rm=TRUE))

ggplot(bydatesgrouped2,aes(x=nday,y=avgdelay)) +
  geom_line(width=2) +
  geom_point() +
  geom_vline(xintercept=20.5) +
  annotate("text", label = "Thanksgiving Holiday", x = 23.4, y = 22, size = 3, colour = "black") +
  theme_calc() +
  xlab('Number Day In 25 Day Period Ending With Sunday After Thanksgiving') +
  ylab('Average Delay') + 
  ggtitle('How Average Major Airline Delays Evolve During November') +
  labs(subtitle='20 Days Before Thanksgiving Travel Period + Five Days During Thanksgiving Holiday') +
  scale_colour_manual(
    values = c('red','blue','darkgreen','orange'),
    aesthetics = c("colour", "fill")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))
```


```{r echo=FALSE}
bydatesgrouped3 = bydates %>%
  group_by(nday,year) %>%
  summarize(cancellations = sum(CANCELLED,na.rm=TRUE)) %>%
  mutate(divider = ifelse(nday>20,5,20)) %>%
  mutate(cancelled_per_day = cancellations/divider)

g = ggplot(bydatesgrouped3,aes(x=nday,y=cancelled_per_day,color=as.factor(year)),) +
  geom_line(width=2) +
  geom_point() +
  geom_vline(xintercept=20.5) +
  annotate("text", label = "Thanksgiving Holiday", x = 23.4, y = -8, size = 3, colour = "black") +
  theme_calc() +
  xlab('Number Day In 25 Day Period Ending With Sunday After Thanksgiving') +
  ylab('Cancellations Per Day') + 
  ggtitle('How Average Major Airline Cancellations Evolve During November, 2015-2018') +
  labs(subtitle='20 Days Before Thanksgiving Travel Period + Five Days During Thanksgiving Holiday') +
  scale_colour_manual(
    values = c('red','blue','darkgreen','orange'),
    aesthetics = c("colour", "fill")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  guides(color=guide_legend(title="Year")) +
  theme(legend.title = element_text(hjust = 0.5)) 

g
```

```{r echo=FALSE}
g + coord_cartesian(ylim=c(0,20))
```

```{r echo=FALSE}
bydatesgrouped4 = bydates %>%
  group_by(nday) %>%
  summarize(cancellations = sum(CANCELLED,na.rm=TRUE)) %>%
  mutate(divider = ifelse(nday>20,20,80)) %>%
  mutate(cancelled_per_day = cancellations/divider)

ggplot(bydatesgrouped4,aes(x=nday,y=cancelled_per_day),) +
  geom_line(width=2) +
  geom_point() +
  geom_vline(xintercept=20.5) +
  annotate("text", label = "Thanksgiving Holiday", x = 23.4, y = -8, size = 3, colour = "black") +
  theme_calc() +
  xlab('Day In 25 Day Period Ending With Sunday After Thanksgiving') +
  ylab('Cancellations Per Day') + 
  ggtitle('How Average Major Airline Cancellations Evolve During November, 2015-2018') +
  labs(subtitle='20 Days Before Thanksgiving Travel Period + Five Days During Thanksgiving Holiday') +
  scale_colour_manual(
    values = c('red','blue','darkgreen','orange'),
    aesthetics = c("colour", "fill")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) 
```

These graphs yield an unexpected result - it seems that, generally, the Wednesday before Thanksgiving (day 21) isn't nearly as bad of a travel day as the weekend before Thanksgiving, which appears to be a terrible time for travel. The weekend after Thanksgiving is messy too, but is clearly affected by a disastrous Thanksgiving Sunday 2018 (this may have been related to a blizzard that struck the middle of the country that weekend, although we can't say that for sure).

This suggests that leaving early for the Thanksgiving holiday doesn't make you less prone to delays, while coming home a day or two early could make your flight more reliable.

In conclusion, the days around Thanksgiving are relatively calm - it's the weekends before and after Thanksgiving that cause the most problems for travelers.

test

